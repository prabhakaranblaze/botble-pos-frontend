openapi: 3.0.3
info:
  title: StampSmart POS API
  description: |
    Complete API reference for the StampSmart POS Desktop Application.

    ## Overview
    This API powers a professional Point of Sale (POS) desktop application built with Flutter for Windows.

    ## Features
    - User Authentication with JWT tokens
    - Product Management with variant support
    - Shopping Cart operations
    - Order processing and receipts
    - Cash Register session management
    - Offline-first architecture support

    ## Authentication
    Most endpoints require a Bearer token obtained from `/auth/login`.
    Include the token in the `Authorization` header: `Bearer {token}`
  version: 1.0.0
  contact:
    name: StampSmart Support
    email: support@stampsmart.com
  license:
    name: Proprietary

servers:
  - url: https://stampsmart.test/api/v1/pos
    description: Development Server
  - url: https://api.stampsmart.com/api/v1/pos
    description: Production Server

tags:
  - name: Authentication
    description: User login, logout, and session management
  - name: Products
    description: Product catalog and barcode scanning
  - name: Cart
    description: Shopping cart operations
  - name: Customers
    description: Customer search and creation
  - name: Orders
    description: Checkout and order management
  - name: Sessions
    description: Cash register session management
  - name: Denominations
    description: Currency denomination lookups

security:
  - bearerAuth: []
  - apiKey: []

paths:
  /auth/login:
    post:
      tags:
        - Authentication
      summary: User Login
      description: Authenticate a user and receive an access token for subsequent API calls.
      operationId: login
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
            example:
              username: admin@example.com
              password: "12345678"
              device_name: POS-Terminal-01
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginResponse'
              example:
                error: false
                message: Login successful
                data:
                  token: eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...
                  user:
                    id: 1
                    name: Admin User
                    email: admin@example.com
                    store_id: 1
                    store_name: Main Store
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/me:
    get:
      tags:
        - Authentication
      summary: Get Current User
      description: Retrieve the authenticated user's profile information.
      operationId: getCurrentUser
      responses:
        '200':
          description: User profile retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: boolean
                    example: false
                  data:
                    type: object
                    properties:
                      user:
                        $ref: '#/components/schemas/User'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/logout:
    post:
      tags:
        - Authentication
      summary: User Logout
      description: Logout the current user and invalidate the session.
      operationId: logout
      responses:
        '200':
          description: Logout successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: boolean
                    example: false
                  message:
                    type: string
                    example: Logged out successfully

  /products:
    get:
      tags:
        - Products
      summary: List Products
      description: Retrieve a paginated list of products. Supports search by name, SKU, or barcode.
      operationId: getProducts
      parameters:
        - name: page
          in: query
          description: Page number
          schema:
            type: integer
            default: 1
            minimum: 1
        - name: per_page
          in: query
          description: Items per page
          schema:
            type: integer
            default: 20
            minimum: 1
            maximum: 100
        - name: search
          in: query
          description: Search by name, SKU, or barcode
          schema:
            type: string
      responses:
        '200':
          description: Products retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProductListResponse'

  /products/scan-barcode:
    post:
      tags:
        - Products
      summary: Scan Barcode
      description: Find a product by scanning its barcode. Returns the product if found, null otherwise.
      operationId: scanBarcode
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - barcode
              properties:
                barcode:
                  type: string
                  description: Product barcode
                  example: "1234567890123"
      responses:
        '200':
          description: Barcode scan result
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: boolean
                    example: false
                  data:
                    type: object
                    properties:
                      product:
                        $ref: '#/components/schemas/Product'
                        nullable: true

  /products/categories:
    get:
      tags:
        - Products
      summary: List Categories
      description: Get all product categories with product counts.
      operationId: getCategories
      responses:
        '200':
          description: Categories retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: boolean
                    example: false
                  data:
                    type: object
                    properties:
                      categories:
                        type: array
                        items:
                          $ref: '#/components/schemas/Category'

  /cart/add:
    post:
      tags:
        - Cart
      summary: Add to Cart
      description: Add a product to the shopping cart. Supports product variants/attributes.
      operationId: addToCart
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AddToCartRequest'
            example:
              product_id: 1
              quantity: 2
              attributes:
                "1": 2
                "2": 4
      responses:
        '200':
          description: Product added to cart
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CartResponse'

  /cart/update:
    post:
      tags:
        - Cart
      summary: Update Cart Item
      description: Update the quantity of an item in the cart.
      operationId: updateCart
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - product_id
                - quantity
              properties:
                product_id:
                  type: integer
                  description: Product ID to update
                quantity:
                  type: integer
                  description: New quantity
                  minimum: 1
            example:
              product_id: 1
              quantity: 3
      responses:
        '200':
          description: Cart updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CartResponse'

  /cart/remove:
    post:
      tags:
        - Cart
      summary: Remove from Cart
      description: Remove an item from the cart.
      operationId: removeFromCart
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - product_id
              properties:
                product_id:
                  type: integer
                  description: Product ID to remove
            example:
              product_id: 1
      responses:
        '200':
          description: Item removed from cart
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CartResponse'

  /cart/clear:
    post:
      tags:
        - Cart
      summary: Clear Cart
      description: Remove all items from the cart.
      operationId: clearCart
      responses:
        '200':
          description: Cart cleared
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: boolean
                    example: false
                  message:
                    type: string
                    example: Cart cleared

  /cart/update-payment-method:
    post:
      tags:
        - Cart
      summary: Update Payment Method
      description: Set the payment method for the current cart.
      operationId: updatePaymentMethod
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - payment_method
              properties:
                payment_method:
                  type: string
                  enum: [cash, card]
                  description: Payment method
            example:
              payment_method: cash
      responses:
        '200':
          description: Payment method updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CartResponse'

  /customers/search:
    get:
      tags:
        - Customers
      summary: Search Customers
      description: Search for customers by name, email, or phone.
      operationId: searchCustomers
      parameters:
        - name: keyword
          in: query
          required: true
          description: Search keyword
          schema:
            type: string
      responses:
        '200':
          description: Customers found
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: boolean
                    example: false
                  data:
                    type: object
                    properties:
                      customers:
                        type: array
                        items:
                          $ref: '#/components/schemas/Customer'

  /customers:
    post:
      tags:
        - Customers
      summary: Create Customer
      description: Register a new customer.
      operationId: createCustomer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateCustomerRequest'
            example:
              name: Jane Smith
              email: jane@example.com
              phone: "+1987654321"
              address: 456 Oak Ave, Town
      responses:
        '200':
          description: Customer created
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: boolean
                    example: false
                  data:
                    type: object
                    properties:
                      customer:
                        $ref: '#/components/schemas/Customer'

  /orders:
    post:
      tags:
        - Orders
      summary: Checkout
      description: Complete checkout and create an order from the current cart.
      operationId: checkout
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                payment_details:
                  type: string
                  description: Additional payment information
                  example: "Last 4 digits: 1234"
      responses:
        '200':
          description: Order created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderResponse'

  /orders/{id}/receipt:
    get:
      tags:
        - Orders
      summary: Get Receipt
      description: Get the HTML receipt for an order.
      operationId: getReceipt
      parameters:
        - name: id
          in: path
          required: true
          description: Order ID
          schema:
            type: integer
      responses:
        '200':
          description: Receipt retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: boolean
                    example: false
                  data:
                    type: object
                    properties:
                      receipt_html:
                        type: string
                        description: HTML content of the receipt

  /cash-registers:
    get:
      tags:
        - Sessions
      summary: List Cash Registers
      description: Get all available cash registers for the store.
      operationId: getCashRegisters
      responses:
        '200':
          description: Cash registers retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: boolean
                    example: false
                  data:
                    type: object
                    properties:
                      cash_registers:
                        type: array
                        items:
                          $ref: '#/components/schemas/CashRegister'

  /sessions/active:
    get:
      tags:
        - Sessions
      summary: Get Active Session
      description: Check if there's an active session for the current user.
      operationId: getActiveSession
      responses:
        '200':
          description: Active session found
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: boolean
                    example: false
                  data:
                    type: object
                    properties:
                      session:
                        $ref: '#/components/schemas/Session'
        '404':
          description: No active session

  /sessions/open:
    post:
      tags:
        - Sessions
      summary: Open Session
      description: Open a new cash register session at the start of a shift.
      operationId: openSession
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/OpenSessionRequest'
            example:
              cash_register_id: 1
              opening_cash: 200.00
              opening_denominations:
                "100": 1
                "50": 2
              opening_notes: Starting morning shift
      responses:
        '200':
          description: Session opened
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: boolean
                    example: false
                  data:
                    type: object
                    properties:
                      session:
                        $ref: '#/components/schemas/Session'

  /sessions/close:
    post:
      tags:
        - Sessions
      summary: Close Session
      description: Close the current cash register session at the end of a shift.
      operationId: closeSession
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CloseSessionRequest'
            example:
              session_id: 101
              closing_cash: 450.00
              closing_denominations:
                "100": 3
                "50": 2
                "20": 2
                "10": 1
              closing_notes: End of morning shift
      responses:
        '200':
          description: Session closed
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: boolean
                    example: false
                  data:
                    type: object
                    properties:
                      session:
                        $ref: '#/components/schemas/Session'

  /denominations:
    get:
      tags:
        - Denominations
      summary: List Denominations
      description: Get available currency denominations for cash counting.
      operationId: getDenominations
      parameters:
        - name: currency
          in: query
          description: Currency code
          schema:
            type: string
            default: USD
            enum: [USD, INR]
      responses:
        '200':
          description: Denominations retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: boolean
                    example: false
                  data:
                    type: object
                    properties:
                      denominations:
                        type: array
                        items:
                          $ref: '#/components/schemas/Denomination'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token obtained from /auth/login
    apiKey:
      type: apiKey
      in: header
      name: X-API-KEY
      description: API key for authentication

  schemas:
    LoginRequest:
      type: object
      required:
        - username
        - password
        - device_name
      properties:
        username:
          type: string
          description: User email or username
        password:
          type: string
          format: password
          description: User password
        device_name:
          type: string
          description: Name identifying this POS terminal

    LoginResponse:
      type: object
      properties:
        error:
          type: boolean
          example: false
        message:
          type: string
        data:
          type: object
          properties:
            token:
              type: string
              description: JWT access token
            user:
              $ref: '#/components/schemas/User'

    User:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        email:
          type: string
          format: email
        store_id:
          type: integer
          nullable: true
        store_name:
          type: string
          nullable: true

    Product:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        sku:
          type: string
          nullable: true
        barcode:
          type: string
          nullable: true
        price:
          type: number
          format: double
        sale_price:
          type: number
          format: double
          nullable: true
        image:
          type: string
          format: uri
          nullable: true
        quantity:
          type: integer
          nullable: true
        description:
          type: string
          nullable: true
        is_available:
          type: boolean
          default: true
        has_variants:
          type: boolean
          default: false
        variants:
          type: array
          nullable: true
          items:
            $ref: '#/components/schemas/ProductVariant'

    ProductVariant:
      type: object
      properties:
        id:
          type: integer
        type:
          type: string
          description: Variant type (e.g., "attribute")
        name:
          type: string
          description: Variant name (e.g., "Size", "Color")
        options:
          type: array
          items:
            $ref: '#/components/schemas/VariantOption'

    VariantOption:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
          description: Option name (e.g., "Small", "Blue")
        price_modifier:
          type: number
          format: double
          nullable: true
          description: Price adjustment for this option

    Category:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        product_count:
          type: integer

    ProductListResponse:
      type: object
      properties:
        error:
          type: boolean
          example: false
        data:
          type: object
          properties:
            products:
              type: array
              items:
                $ref: '#/components/schemas/Product'
            pagination:
              type: object
              properties:
                current_page:
                  type: integer
                per_page:
                  type: integer
                total:
                  type: integer
                last_page:
                  type: integer

    AddToCartRequest:
      type: object
      required:
        - product_id
        - quantity
      properties:
        product_id:
          type: integer
          description: Product ID to add
        quantity:
          type: integer
          minimum: 1
          description: Quantity to add
        attributes:
          type: object
          additionalProperties:
            type: integer
          description: Variant selections as variant_id:option_id pairs

    CartItem:
      type: object
      properties:
        id:
          type: integer
          description: Product ID
        name:
          type: string
        sku:
          type: string
          nullable: true
        price:
          type: number
          format: double
        quantity:
          type: integer
        image:
          type: string
          format: uri
          nullable: true

    Cart:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/CartItem'
        subtotal:
          type: number
          format: double
        discount:
          type: number
          format: double
        tax:
          type: number
          format: double
        shipping_amount:
          type: number
          format: double
        total:
          type: number
          format: double
        payment_method:
          type: string
          nullable: true
          enum: [cash, card]
        coupon_code:
          type: string
          nullable: true

    CartResponse:
      type: object
      properties:
        error:
          type: boolean
          example: false
        data:
          $ref: '#/components/schemas/Cart'

    Customer:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        email:
          type: string
          format: email
          nullable: true
        phone:
          type: string
          nullable: true
        address:
          type: string
          nullable: true

    CreateCustomerRequest:
      type: object
      required:
        - name
      properties:
        name:
          type: string
        email:
          type: string
          format: email
        phone:
          type: string
        address:
          type: string

    Order:
      type: object
      properties:
        id:
          type: integer
        code:
          type: string
          description: Order reference code
        amount:
          type: number
          format: double
        payment_method:
          type: string
          enum: [cash, card]
        status:
          type: string
        created_at:
          type: string
          format: date-time
        payment_details:
          type: string
          nullable: true
        items:
          type: array
          items:
            $ref: '#/components/schemas/CartItem'

    OrderResponse:
      type: object
      properties:
        error:
          type: boolean
          example: false
        data:
          type: object
          properties:
            order:
              $ref: '#/components/schemas/Order'

    CashRegister:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        code:
          type: string
        store_id:
          type: integer
        description:
          type: string
          nullable: true
        is_active:
          type: boolean
        initial_float:
          type: number
          format: double
          nullable: true

    Session:
      type: object
      properties:
        id:
          type: integer
        cash_register_id:
          type: integer
        cash_register_name:
          type: string
          nullable: true
        user_id:
          type: integer
        user_name:
          type: string
          nullable: true
        status:
          type: string
          enum: [open, closed]
        opened_at:
          type: string
          format: date-time
        closed_at:
          type: string
          format: date-time
          nullable: true
        opening_cash:
          type: number
          format: double
        closing_cash:
          type: number
          format: double
          nullable: true
        opening_denominations:
          type: object
          additionalProperties:
            type: integer
          nullable: true
        closing_denominations:
          type: object
          additionalProperties:
            type: integer
          nullable: true
        opening_notes:
          type: string
          nullable: true
        closing_notes:
          type: string
          nullable: true
        difference:
          type: number
          format: double
          nullable: true
          description: Cash difference (short/excess)

    OpenSessionRequest:
      type: object
      required:
        - cash_register_id
        - opening_cash
      properties:
        cash_register_id:
          type: integer
        opening_cash:
          type: number
          format: double
        opening_denominations:
          type: object
          additionalProperties:
            type: integer
          description: Count of each denomination
        opening_notes:
          type: string

    CloseSessionRequest:
      type: object
      required:
        - session_id
        - closing_cash
      properties:
        session_id:
          type: integer
        closing_cash:
          type: number
          format: double
        closing_denominations:
          type: object
          additionalProperties:
            type: integer
          description: Count of each denomination
        closing_notes:
          type: string

    Denomination:
      type: object
      properties:
        id:
          type: integer
        currency:
          type: string
        value:
          type: number
          format: double
        type:
          type: string
          enum: [bill, coin]
        display_name:
          type: string

    ErrorResponse:
      type: object
      properties:
        error:
          type: boolean
          example: true
        message:
          type: string
          description: Error message
